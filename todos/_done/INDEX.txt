_DONE Plan Index (Living Doc)

Purpose
=======
- Quick reference for completed plans in this folder.
- Each entry should tell you why it existed, what happened, and where to read more.

How to extend this index
1) Add a new entry with the same fields as existing ones:
   - Plan: filename (the original plan)
   - Context: filename (the execution summary / outcome)
   - Why: 1-2 sentences on the problem or motivation
   - Outcome: 2-4 bullets on what changed or was implemented
   - Notes: optional cautions, follow-ups, or deviations from the plan
2) Ensure plan filenames include the time (e.g., 2026-01-27-12pm_...) based on the current date/time (`date` in shell) when the plan is written.
   - If a plan file doesn’t already follow the timestamped naming convention, rename it using the file’s creation or last-modified metadata (localized to NYC time) and update references.
3) Keep summaries short; link to the plan + context for full detail.
4) If a plan was only partially implemented, state that explicitly.
5) Add new entries in reverse-chronological order by plan timestamp (newest first) so `head` shows the latest work.
6) Run `python3 todos/_done/reorder_index.py` to verify ordering after edits.

Entries
=======

- Plan: 2026-01-28-1pm_session-view-floating-controls-and-shortcuts.txt
  Context: 2026-01-28-1pm_session-view-floating-controls-and-shortcuts-context.txt
  Why: Session controls, shortcuts, and search clearing were easy to lose in long sessions and needed clearer, sticky access.
  Outcome:
  - Added a single sticky toggle/shortcut bar with a focus scope indicator and clickable keycap hints.
  - Implemented focus-gated navigation (Cmd/Ctrl+↑/↓, Cmd/Ctrl+K, ArrowLeft/Right) and removed duplicate match panels.
  - Refined search UX: Lucide clear buttons, session q clear without reload, sidebar search reset on session open, active query shown in the sticky bar.
  - Retained /stickytest as a dev/QA route and left-aligned the header subtitle row.
  Notes:
  - Addendum completed: 2026-01-28-1pm_session-view-floating-controls-and-shortcuts-addendum.txt

- Plan: 2026-01-27-10pm_active-duration-consistency-plan.txt
  Context: 2026-01-27-10pm_active-duration-consistency-plan-context.txt
  Why: Active duration undercounted tool-heavy turns and differed between indexed vs unindexed sessions.
  Outcome:
  - Shared active-duration definition across server indexing + client parsing with a shared accumulator.
  - Included assistant reasoning and tool calls/outputs (including web search outputs) as activity.
  - Added per-turn active duration in the parse pass and surfaced it as a turn-level pill with seconds for sub-hour spans.
  Notes:
  - Reindex is required to backfill session-level active_duration_ms in SQLite.

- Plan: 2026-01-27-2pm_search-min-token-length-plan.txt
  Context: 2026-01-27-2pm_search-min-token-length-plan-context.txt
  Why: Single-letter searches were noisy and expensive; we wanted a softer minimum length without breaking non-Latin queries.
  Outcome:
  - Added script-aware “searchable token” rules (Latin >= 3, numeric >= 2, non-Latin >= 1) in normalizeFtsQuery.
  - Mirrored the same rules and token cap in useSearch to keep client/server behavior aligned.
  - Added a “Type at least 3 characters to search” hint and suppressed the empty state when queries are too short.
  Notes:
  - Latin short tokens like “AI”/“Go” are intentionally blocked unless paired with a longer token.

- Plan: 2026-01-27-12pm_search-sorting-controls-plan.txt
  Context: 2026-01-27-12pm_search-sorting-controls-context.txt
  Why: Make result/workspace ordering explicit so users can choose relevance vs match count vs recency without confusion.
  Outcome:
  - Added resultSort/groupSort params end-to-end (types, UI controls, and server ordering).
  - Implemented mobile sort disclosure + container-query layout adjustments.
  - Search loading now uses a results-area skeleton; group last_seen fallback uses the latest session timestamp.
  Notes:
  - Defaults preserved; server applies relevance + last_seen when params are absent.

- Plan: 2026-01-27-12pm_search-api-refactor-plan.txt
  Context: 2026-01-27-12pm_search-api-refactor-plan-context.txt
  Why: Split the monolithic search API into focused modules and improve search performance without changing UI contracts.
  Outcome:
  - Introduced a router + shared HTTP helpers; apiPlugin now delegates to route handlers.
  - Extracted config, DB/logging, indexing/session tree, search normalization/queries, and workspace helpers into dedicated modules.
  - Applied workspace filtering in the matches CTE and limited workspace summaries to result workspaces (Option A).
  - Added Server-Timing headers and requestId echoing for /api/search and /api/session-matches; shared API types now live in shared/apiTypes.ts.
  Notes:
  - Tests were deferred per the plan (steps 10–11 not implemented).

- Plan: 2026-01-27-2am_search-result-dedupe-and-metadata-plan.txt
  Context: 2026-01-27-12am_search-roadmap-context.txt
  Why: Proposed de-duplicating search rows by session UUID and adding per-session pills.
  Outcome:
  - Deprecated. Session UUID de-dup was rejected after discovering branched sessions reuse ancestor IDs.
  - Per-session pills were implemented via the consolidated search roadmap work.
  Notes:
  - Plan archived in todos/_archive with a deprecation notice.

- Plan: 2026-01-27-12am_search-roadmap-context.txt
  Context: 2026-01-27-12am_search-roadmap-context.txt
  Why: Consolidate the search roadmap into a single completion record.
  Outcome:
  - Documents completion state for debounce status, UUID resolve/FTS normalization, aggregation, and match navigation.
  - Records the correction: filename session_id wins; UUID de-duplication is intentionally not used.
  Notes:
  - Use this context file as the canonical search roadmap summary.

- Plan: 2026-01-26-11pm_search-result-session-aggregation-plan.txt
  Context: 2026-01-27-12am_search-roadmap-context.txt
  Why: Per-message search rows were noisy; we needed one row per session with match navigation.
  Outcome:
  - Aggregated /api/search results per session with match counts + snippets.
  - Added /api/session-matches, ?q= deep links, highlight + next/prev match navigation.
  - Search result rows show per-session pills (date/time, duration, turns, branch) with icons.
  Notes:
  - Per-file grouping is intentional after fixing session_id indexing for branched sessions.

- Plan: 2026-01-26-11pm_search-uuid-resolve-and-fts-normalization-plan.txt
  Context: 2026-01-27-12am_search-roadmap-context.txt
  Why: Raw FTS queries broke on UUIDs/special chars and UUID paste should open sessions directly.
  Outcome:
  - Server-side FTS normalization (Unicode-aware tokens, quoted ANDs, token cap).
  - Fixed /api/resolve-session ESCAPE handling; Enter-to-resolve retained.
  - Added UUID paste auto-resolve with debounce suppression and logging.
  Notes:
  - Client accepts any UUID; resolve endpoint is authoritative.

- Plan: 2026-01-26-11pm_turn-navigation-plan.txt
  Context: 2026-01-26-11pm_turn-navigation-plan-context.txt
  Why: Add fast turn-to-turn navigation (arrow keys + scroll-aware URL updates) without re-fetching or re-parsing sessions, and prep a turn jump modal.
  Outcome:
  - Added jumpToTurn API plus IntersectionObserver tracking to keep ?turn in sync on scroll.
  - Implemented top sentinel clearing, URL de-dupe, and session-aware resets to prevent stale or skipped updates.
  - Added ArrowLeft/ArrowRight navigation, Cmd/Ctrl+K “Go to turn” modal, and a header shortcut button.
  - Added turn-nav debug flag (VITE_TURN_NAV_DEBUG) for structured logging.
  Notes:
  - Navigation skips session preamble; URL updates use replaceState.
  - Turn activation uses a top 10% focus band for stability.

- Plan: 2026-01-26-10pm_search-debounce-state-plan.txt
  Context: 2026-01-27-12am_search-roadmap-context.txt
  Why: The search empty state flashed during debounce because “no results” and “no search yet” were indistinguishable.
  Outcome:
  - Added explicit searchStatus lifecycle (idle/debouncing/loading/success/error) and derived loading flags.
  - Updated SearchPanel and Sidebar to render empty/error/searching based on status.
  - Added detailed status transition logging for lifecycle debugging.
  Notes:
  - Results are cleared on query change; empty state only appears after success.

- Plan: 2026-01-26-9pm_chip-utility-unification-plan.txt
  Context: 2026-01-26-9pm_chip-utility-unification-plan-context.txt
  Why: Consolidate duplicated pill/chip styles (VariantB + compact toggles) into a reusable utility system, then align VariantA and SessionsPanel for consistency.
  Outcome:
  - Added composable chip utilities (sizes, backgrounds, helpers) plus meta-row and segmented chip helpers.
  - Refactored SessionHeaderVariantB, SessionHeader (VariantA), SessionsPanel, and compact toggles to use the shared chip language.
  - Unified copy buttons (MessageCard, TokenCountCard, copy conversation) with chip utilities while preserving visual parity.
  - Adjusted muted chips, toggle behavior, and meta-row borders based on follow-up review.
  Notes:
  - VariantB visuals were the golden reference; the plan explicitly allowed VariantA to change to match.
  - TokenCountCard segmented pills were only standardized at the wrapper level.

- Plan: 2026-01-23-7pm_canvas-registry-plan.txt
  Context: 2026-01-23-7pm_canvas-registry-plan-context.txt
  Why: Replace hard-coded A/B canvas with a manual registry to scale to multiple demos/variants using real session data.
  Outcome:
  - Added a canvas registry + shared types and moved SessionHeader variants into their own module.
  - Refactored CanvasView to select demos/variants dynamically with per-variant state.
  - Added styling slots to SessionHeader/SessionOverview without changing production defaults.
  Notes:
  - Registry is manual by design (no auto-discovery), and variants own their hooks.

- Plan: 2026-01-23-7pm_db-only-session-picker-plan.txt
  Context: 2026-01-23-7pm_db-only-session-picker-plan-context.txt
  Why: Remove expensive filesystem scans on every picker load and clamp preview sizes for UI stability.
  Outcome:
  - /api/sessions now reads from SQLite only (no scanSessionFiles/readFirstUserMessage).
  - Preview truncation (chars + lines) applied during indexing and response shaping.
  - buildSessionsTree now accepts minimal DB-backed entries (no fake size/mtime).
  - Missing session files return clear 404s; UI surfaces “Please reindex.”
  Notes:
  - Picker can be stale until reindex; this is intentional.

- Plan: 2026-01-23-7pm_unified-indexing-and-picker-plan.txt
  Context: 2026-01-23-7pm_unified-indexing-and-picker-plan-context.txt
  Why: Persist rich session metrics and active duration in SQLite, eliminate joins, and make DB-only picker fast and deterministic.
  Outcome:
  - Sessions table stores metrics (counts, timestamps, active_duration_ms) with safe migrations.
  - /api/sessions now queries sessions only and maps preview directly.
  - UI uses indexed metrics and active duration where available; fallback parsing is aligned.
  - Preview truncation unified across server/client.
  Notes:
  - No backfill; Clear & Rebuild Index required to populate new columns.

- Plan: 2026-01-23-6pm_token-count-visualization-plan.txt
  Context: 2026-01-23-6pm_token-count-visualization-plan-context.txt
  Why: Make token_count items first-class (own toggle, stats, renderer) and align context usage semantics with the CLI.
  Outcome:
  - Added token_count toggle + stats chip; token_count no longer rides the Meta toggle.
  - Introduced TokenCountCard + parsing helpers and Canvas variants for visualization.
  - Indexed token_count_count separately from meta_count; export includes token_count only when toggle is on.
  - Context usage now uses last_token_usage (with fallbacks) for the bar and detail text.
  Notes:
  - Context usage fix plan is documented in 2026-01-23-6pm_token-count-context-usage-fix-plan.txt and summarized in this context doc.
  - Clear & Rebuild Index required to populate the new token_count_count column.

- Plan: 2026-01-22-7pm_best-fix-copy-lag-plan.txt
  Context: 2026-01-22-7pm_best-fix-copy-lag-plan-context.txt
  Why: Copy feedback state was global and caused full-tree re-renders with noticeable lag.
  Outcome:
  - Split ConversationMain from Sidebar to isolate copy state.
  - Introduced CopyButton with localized feedback; header and message copy actions no longer repaint the tree.
  - Added targeted memoization for heavy panels with stable callbacks.
  - Render debug hooks retained but gated behind VITE_RENDER_DEBUG.
  Notes:
  - StrictMode remains enabled; debug logging is opt-in only.

- Plan: 2026-01-22-4pm_useSession-derived-activeSession-plan.txt
  Context: 2026-01-22-4pm_useSession-derived-activeSession-plan-context.txt
  Why: Fix an activeSession sync loop that caused maximum update depth warnings and UI lag by deriving activeSession instead of storing it in state.
  Outcome:
  - useSession now stores only activeSessionId + parsedMeta and derives activeSession via useMemo.
  - Removed the effect that synced activeSession from sessionsTree, eliminating the render loop.
  - clearSession resets the minimal state and derived session metadata is merged deterministically.
  Notes:
  - sessionId fallback uses extractSessionIdFromPath(activeSessionId) when available.

- Plan: 2026-01-21-8pm_workspaces-and-landing-page.txt
  Context: 2026-01-21-8pm_workspaces-and-landing-page-context.txt
  Why: The home state needed to be a discovery dashboard (search + workspaces) rather than a full session viewer.
  Outcome:
  - Added /api/workspaces, workspace filtering, grouped search, and scoped resolve behavior.
  - Implemented home layout with full-width search and Sessions/Workspaces split.
  - Built Workspaces panel with repo metadata and sorting; added Git metadata extraction fixes.
  Notes:
  - Workspace identity is cwd-only; reindex required to populate new git_commit_hash fields.
