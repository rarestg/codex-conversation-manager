Search Roadmap Handoff (Status + Remaining Work)

Context
The search roadmap was implemented in three phases (FTS normalization + UUID resolve, search lifecycle state, and aggregated results + match navigation). The system is now functionally correct and stable, but two UX-level goals from the original request are still missing: true conversation de-duplication across multiple JSONL files that share the same session UUID, and per-session metadata pills in the result rows (date/time + git branch). This handoff summarizes what has been done, what remains, and how the pieces connect.

Where We Stand (Summary)
- Plan 2 (UUID resolve + FTS normalization): complete.
- Plan 1 (search lifecycle status): complete.
- Plan 3 (aggregation + match navigation): mostly complete.
  - Outstanding: (a) de-dup by session UUID, (b) per-session metadata pills.

What Was Implemented
Server (apiPlugin.ts)
- FTS normalization (Unicode-aware tokenization, quoted AND tokens, token cap) now drives /api/search.
- /api/resolve-session ESCAPE bug fixed.
- /api/search returns aggregated session-level results with match counts, snippet, and tokens.
- /api/session-matches supports match navigation and filters turn_id > 0.
- first_match_turn_id now falls back to the first real turn when the top snippet is preamble.

Client (search + navigation)
- Search lifecycle uses searchStatus (idle/debouncing/loading/success/error) and avoids empty-state flash.
- UUID paste auto-resolves and suppresses debounce; resolve failures set error state.
- Match highlighting is limited to matched turns; stale match state is cleared at fetch start.
- URL includes ?q= for deep-linking; Next/Prev match controls implemented.
- Search UI cleanup: title/snippet clamping, snippet normalization (whitespace + repeated char trimming), overflow fixes, container-query based layout, and responsive GitHub link behavior.

Key Files
- server/apiPlugin.ts (search aggregation, normalization, resolve, session matches)
- src/features/conversation/hooks/useSearch.ts
- src/features/conversation/components/SearchPanel.tsx
- src/features/conversation/ConversationMain.tsx
- src/features/conversation/markdown.tsx
- src/features/conversation/url.ts
- src/index.css (container queries for search panel)

Remaining Work
1) De-duplicate “same conversation” rows
Problem: Multiple JSONL files can share the same session UUID (sessions.session_id), but /api/search aggregates by sessions.id/path. This produces duplicate rows for the same conversation.
Fix: Group on a conversation key that prefers session UUIDs when available. See detailed plan below.

2) Add per-session metadata pills (date/time + git branch)
Problem: Rows still look flat compared to session picker; the date/time and git branch are not shown per session, only at the workspace group header.
Fix: Add pills in the session result row, using session_timestamp and git_branch from the search result.

Detailed Plan for Remaining Work
See: todos/2026-01-27-2am_search-result-dedupe-and-metadata-plan.txt
This plan covers:
- Grouping key changes (COALESCE(session_id, session_path)).
- Picking a representative session_path for navigation.
- Ensuring timestamp/branch come from the chosen representative row.
- Updating the SearchPanel row rendering with pills.
- Verification steps to confirm de-duping and UI correctness.

Landmines / Gotchas
- session_id vs session_path: UI must navigate with session_path (sessions.id). Grouping by session_id must not break this.
- Representative row mismatch: if you choose “best match” for session_path but “latest timestamp” for metadata, document the tradeoff in code comments to avoid confusion later.
- Container queries: some SearchPanel behaviors depend on container-name: search-panel; avoid reintroducing Tailwind utilities that override component-layer CSS.

Verification Checklist (Current State)
- FTS normalization: no parser errors on UUIDs/special chars; tokens logged.
- UUID paste: resolves immediately; debounce suppressed; errors set status.
- Search lifecycle: empty state no longer flashes; error state renders properly.
- Aggregation: one row per session path, counts correct, match navigation works.

Verification Checklist (Remaining Work)
- Duplicate session_id entries no longer produce multiple rows.
- Result row shows date/time + git branch pills in both wide and narrow layouts.
- Clicking a deduped row still opens a valid session path.

Notes on Recent UI Work
- Title clamps to 2 lines (3 lines in narrow containers).
- Snippet clamps to 3 lines, breaks words, and normalizes whitespace/repeated characters.
- Workspace header stacks based on container width (search panel, not viewport).
- “Open on GitHub” link hidden in narrow views; GitHub icon remains clickable with confirmation.

Ownership / Status (fill in as needed)
- Remaining work owner: ____________________
- Start date: ______________________________
- Target date: _____________________________
